---
title: "RGCCA for Feature Engineering - QRT Football data challenge 2024"
author: "Théo Saulus, Timothé Boulet"
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_caption: yes
    fig_height: 8
    fig_width: 8
    number_sections: yes
    toc: yes
  html_document:
    toc: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height=7, fig.width=8)
```

# Load packages
```{r}
# set working directory to current folder
current_dir = dirname(rstudioapi::getSourceEditorContext()$path)
setwd(dirname(current_dir))

library(readr)
library(RGCCA)
library(tidyverse)
library(abind) # For array binding
library(dplyr)

```

# Load data 
```{r}
# load home and away team statistics
team_home <- read_csv("../datas_final/train_home_team_statistics_df.csv")
team_away <- read_csv("../datas_final/train_away_team_statistics_df.csv")
Y <- read_csv("../datas_final/Y_train.csv")
player_mapping <- read_csv("../data/player_mapping.csv")

# Filter first column of Y
Y <- Y %>% select(-c(1))

# Convert Y to a factor, depending on which column is equal to 1
Y <- as.factor(apply(Y, 1, which.max)) # 1 if home team wins, 2 if draw, 3 if away team wins

# load home and away player statistics
player_home <- read_csv("../datas_final/train_home_player_statistics_df.csv")
player_away <- read_csv("../datas_final/train_away_player_statistics_df.csv")

# Rename column ID to ID_team in player_away
colnames(player_away)[1] <- "ID_team"

# Name the rows and columns for the teams
rownames(team_home) <- team_home$ID_team
rownames(team_away) <- team_away$ID_team

# Filter features to remove "LEAGUE", "TEAM_NAME", "POSITION", "PLAYER_NAME" 
#player_home <- player_home %>% select(-c(2:5))
#player_away <- player_away %>% select(-c(2:5))
player_home <- player_home %>% select(-c(2,3,5))
player_away <- player_away %>% select(-c(2,3,5))

# Filter features that end with season_average, 5_last_match_sum, 5_last_match_average, 5_last_match_std
player_home <- player_home %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
player_away <- player_away %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
team_home <- team_home %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
team_away <- team_away %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))

# Filter features that start with PLAYER_CAPTAIN, PLAYER_LONG_BALLS, PLAYER_LONG_BALLS_WON, PLAYER_SHOTS_OFF_TARGET
player_home <- player_home %>% select(-c(starts_with("PLAYER_CAPTAIN"), starts_with("PLAYER_LONG_BALLS"), starts_with("PLAYER_LONG_BALLS_WON"), starts_with("PLAYER_SHOTS_OFF_TARGET"), starts_with("PLAYER_PUNCHES")))
player_away <- player_away %>% select(-c(starts_with("PLAYER_CAPTAIN"), starts_with("PLAYER_LONG_BALLS"), starts_with("PLAYER_LONG_BALLS_WON"), starts_with("PLAYER_SHOTS_OFF_TARGET"), starts_with("PLAYER_PUNCHES")))

player_home_raw <- player_home
player_away_raw <- player_away
```

# Load test data
```{r}
# load home and away team statistics
team_home_test <- read_csv("../datas_final/test_home_team_statistics_df.csv")
team_away_test <- read_csv("../datas_final/test_away_team_statistics_df.csv")
player_home_test <- read_csv("../datas_final/test_home_player_statistics_df.csv")
player_away_test <- read_csv("../datas_final/test_away_player_statistics_df.csv")

# Filter features that end with season_average, 5_last_match_sum, 5_last_match_average, 5_last_match_std
team_home_test <- team_home_test %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
team_away_test <- team_away_test %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
player_home_test <- player_home_test %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))
player_away_test <- player_away_test %>% select(-c(ends_with("season_average"), ends_with("5_last_match_sum"), ends_with("5_last_match_average"), ends_with("5_last_match_std")))

# Filter features that start with PLAYER_CAPTAIN, PLAYER_LONG_BALLS, PLAYER_LONG_BALLS_WON, PLAYER_SHOTS_OFF_TARGET
player_home_test <- player_home_test %>% select(-c(starts_with("PLAYER_CAPTAIN"), starts_with("PLAYER_LONG_BALLS"), starts_with("PLAYER_LONG_BALLS_WON"), starts_with("PLAYER_SHOTS_OFF_TARGET"), starts_with("PLAYER_PUNCHES")))
player_away_test <- player_away_test %>% select(-c(starts_with("PLAYER_CAPTAIN"), starts_with("PLAYER_LONG_BALLS"), starts_with("PLAYER_LONG_BALLS_WON"), starts_with("PLAYER_SHOTS_OFF_TARGET"), starts_with("PLAYER_PUNCHES")))
```

# Structuring 2nd order tensors for players

```{r}
createTensor <- function(dataframe) {
  # Identify unique teams and sort to maintain consistent order
  teams <- sort(unique(dataframe$ID_team))
  
  # Find the maximum number of players in any team
  maxPlayers <- max(table(dataframe$ID_team))
  
  # Number of features per player (excluding the ID_team column)
  numFeatures <- ncol(dataframe) - 1
  
  # Initialize an empty array to hold the tensor
  # The dimensions are: length(teams) x numFeatures x maxPlayers
  tensor <- array(NA, dim = c(length(teams), numFeatures, maxPlayers))

  print(paste("Tensor dimensions: ", length(teams), "*", numFeatures, "*", maxPlayers))
  
  # Fill the tensor with data
  for (i in seq_along(teams)) {
    # Print team number every 500 teams
    if (i %% 1000 == 0) {
      print(paste("Processing team", i, "of", length(teams)))
    }

    teamData <- subset(dataframe, ID_team == teams[i])
    
    # Ensure data is ordered or filtered as needed before this step
    playerData <- as.matrix(teamData[,-1]) # Exclude ID_team column
    
    # Determine how many players this team has
    numPlayers <- nrow(playerData)
    
    # Fill the tensor for this team
    # If a team has fewer players, remaining slots will stay as NA
    tensor[i,,1:numPlayers] <- t(playerData)
  }
  
  return(tensor)
}
```


```{r}
position_filter = "" # attacker, defender, midfielder, goalkeeper

# Filter by position, if relevant
if (position_filter != "") {
  player_home <- player_home_raw %>% filter(POSITION == position_filter)
  player_away <- player_away_raw %>% filter(POSITION == position_filter)
}

# Remove the position column
player_home <- player_home %>% select(-c(2))
player_away <- player_away %>% select(-c(2))
```


```{r}
player_home_tensor <- createTensor(player_home)
player_away_tensor <- createTensor(player_away)
```


# TGCCA for feature engineering
Our aim is to use RGCCA with 4 blocs (teams features and players features, for both home and away teams) to predict the Y variable, in a "bow tie" structure. 
```{r}
# Remove the first 3 columns from the team tensors
team_home_cut <- as.matrix(team_home[,-c(1:3)])
team_away_cut <- as.matrix(team_away[,-c(1:3)])

L = list(team_home_cut, player_home_tensor, team_away_cut, player_away_tensor, Y)
C = matrix(c(0,1,0,0,1,
             1,0,0,0,1,
             0,0,0,1,1,
             0,0,1,0,1,
             1,1,1,1,0), nrow = 5, ncol = 5)
```

```{r}
fit_tgcca <- rgcca(
    blocks = L, 
    connection = C, 
    method = "tgcca", 
    rank = 1,
    tau = 1, 
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    init = "random", 
    tol = 1e-8,
    response = 5
  )
```

```{r}
plot(fit_tgcca, type= "sample", comp = 1:2, block = 1, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 2, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 3, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 4, title = "Factorial plan of TGCCA", resp = Y)
```

```{r}
# projection of block 4 on the two PC of block 2
plot(fit_tgcca, type='cor_circle', comp=1:2)
```

```{r}
plot(fit_tgcca, display_order = TRUE, comp=1, block = c(1,3))
```

```{r}
plot(fit_tgcca$factors[[4]][[1]][,1])
plot(fit_tgcca$factors[[4]][[2]][,1])
plot(fit_tgcca$factors[[2]][[1]][,1])
plot(fit_tgcca$factors[[2]][[2]][,1])

important_player_factors_home <- fit_tgcca$factors[[2]][[1]][,1]
important_player_factors_away <- fit_tgcca$factors[[4]][[1]][,1]

names(important_player_factors_away) = colnames(player_away[,-c(1)])
names(important_player_factors_home) = colnames(player_home[,-c(1)])

print(important_player_factors_away[which(abs(important_player_factors_away) > 0.18)])
print(important_player_factors_home[which(abs(important_player_factors_home) > 0.18)])
print(important_player_factors_away)
print(important_player_factors_home)
```


Store the important factors for the players
```{r}
#write.csv(important_player_factors_away, "../data/important_player_factors_away.csv")
#write.csv(important_player_factors_home, "../data/important_player_factors_home.csv")
```


```{r}
plot(fit_tgcca$factors[[4]][[1]][,1], fit_tgcca$factors[[2]][[1]][,1], xlab = "Away team", ylab = "Home team")
text(fit_tgcca$factors[[4]][[1]][,1], fit_tgcca$factors[[2]][[1]][,1], labels = colnames(player_away[,-c(1)]), cex = 0.5)
plot(fit_tgcca$factors[[4]][[2]][,1], fit_tgcca$factors[[2]][[2]][1:23,1], xlab = "Away team", ylab = "Home team")
text(fit_tgcca$factors[[4]][[2]][,1], fit_tgcca$factors[[2]][[2]][1:23,1], labels = colnames(player_away[,-c(1)]), cex = 0.5)
```

```{r}
colnames(player_home[,-c(1)])[which(abs(fit_tgcca$factors[[2]][[1]][,1]) > 0.18)]
colnames(player_away[,-c(1)])[which(abs(fit_tgcca$factors[[4]][[1]][,1]) > 0.18)]

rownames(player_home[,-c(1)])[which(abs(fit_tgcca$factors[[2]][[2]][,1]) > 0.15)]
rownames(player_away[,-c(1)])[which(abs(fit_tgcca$factors[[4]][[2]][,1]) > 0.15)]

```




# Attempt with merged players blocks
```{r}
# Remove the first 3 columns from the team tensors
# team_home_cut <- as.matrix(team_home[,-c(1:3)])
# team_away_cut <- as.matrix(team_away[,-c(1:3)])

# concatenate player blocks along the players dimension
players_block <- abind(player_home_tensor, player_away_tensor, along=3)
L_concat = list(team_home_cut, team_away_cut, players_block, Y)
```

```{r}
fit_tgcca_trunc <- rgcca(
    blocks = L_concat, 
    connection = C, 
    method = "tgcca", 
    rank = 1,
    tau = 1, 
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    init = "random", 
    tol = 1e-8,
    response = 4
  )
```

```{r}
plot(fit_tgcca_trunc, type= "sample", comp = 1:2, block = 1, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca_trunc, type= "sample", comp = 1:2, block = 2, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca_trunc, type= "sample", comp = 1:2, block = 3, title = "Factorial plan of TGCCA", resp = Y)
```

```{r}
plot(fit_tgcca_trunc, type='cor_circle', comp=1:2, block = 1:3)
plot(fit_tgcca_trunc, display_order = TRUE, comp=1, block = 1:3)
plot(fit_tgcca_trunc$factors[[3]][[1]][,1])
plot(fit_tgcca_trunc$factors[[3]][[2]][,1])

```

```{r}
important_player_factors_mixed <- fit_tgcca_trunc$factors[[3]][[1]][,1]
names(important_player_factors_mixed) = colnames(player_home[,-c(1)])
print(important_player_factors_mixed[which(abs(important_player_factors_mixed) > 0.18)])
```

```{r}
# write.csv(important_player_factors_mixed, "../data/important_player_factors_mixed.csv")
```

# Attempt with concatenated players blocks
```{r}
# Remove the first 3 columns from the team tensors
team_home_cut <- as.matrix(team_home[,-c(1:3)])
team_away_cut <- as.matrix(team_away[,-c(1:3)])

L_trunc = list(player_home_tensor, player_away_tensor, Y)
C = matrix(c(0,0,1,
             0,0,1,
             1,1,0), nrow = 3, ncol = 3)
```

```{r}
fit_tgcca_trunc <- rgcca(
    blocks = L_trunc, 
    connection = C, 
    method = "tgcca", 
    rank = 1,
    tau = 1, 
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    init = "random", 
    tol = 1e-8,
    response = 3
  )
```


```{r}
plot(fit_tgcca_trunc, type='cor_circle', comp=1:2, block = 1)
plot(fit_tgcca_trunc, display_order = FALSE, comp=1)
plot(fit_tgcca_trunc$factors[[2]][[2]][,1])
```


# Attempt with only players blocks
```{r}
# Remove the first 3 columns from the team tensors
team_home_cut <- as.matrix(team_home[,-c(1:3)])
team_away_cut <- as.matrix(team_away[,-c(1:3)])

L_trunc = list(player_home_tensor, player_away_tensor, Y)
C = matrix(c(0,0,1,
             0,0,1,
             1,1,0), nrow = 3, ncol = 3)
```

```{r}
fit_tgcca_trunc <- rgcca(
    blocks = L_trunc, 
    connection = C, 
    method = "tgcca", 
    rank = 1,
    tau = 1, 
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    init = "random", 
    tol = 1e-8,
    response = 3
  )
```

```{r}
plot(fit_tgcca_trunc, type= "sample", comp = 1:2, block = 1, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca_trunc, type= "sample", comp = 1:2, block = 2, title = "Factorial plan of TGCCA", resp = Y)
```


```{r}
plot(fit_tgcca_trunc$factors[[1]][[1]][,1])
plot(fit_tgcca_trunc$factors[[1]][[2]][,1])
plot(fit_tgcca_trunc$factors[[2]][[1]][,1])
plot(fit_tgcca_trunc$factors[[2]][[2]][,1])

important_player_factors_home <- fit_tgcca_trunc$factors[[1]][[1]][,1]
important_player_factors_away <- fit_tgcca_trunc$factors[[2]][[1]][,1]

names(important_player_factors_away) = colnames(player_away[,-c(1)])
names(important_player_factors_home) = colnames(player_home[,-c(1)])

print(important_player_factors_away[which(abs(important_player_factors_away) > 0.18)])
print(important_player_factors_home[which(abs(important_player_factors_home) > 0.18)])
```

```{r}
# Save, with name depending on the position_filter
write.csv(important_player_factors_away, paste0("../data/important_player_factors_away_", position_filter, ".csv"))
write.csv(important_player_factors_home, paste0("../data/important_player_factors_home_", position_filter, ".csv"))
```



# Attempt with classic RGCCA
```{r}
L_rgcca = list(TH = team_home_cut, PH = matrix(player_home_tensor, nrow=nrow(player_home_tensor)), TA = team_away_cut, PA = matrix(player_away_tensor, nrow=nrow(player_away_tensor)), Y = Y)
#L2 = list(abind(L_rgcca[1:4], along=2), L_rgcca[[5]])
#L_rgcca <- L2
```

```{r}
fit_rgcca <- rgcca(
    blocks = L_rgcca, 
    connection = C, 
    method = "sgcca",
    tau = "optimal",
    sparsity = c(0.716, 0.674, 0.716, 0.674, 0),
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    init = "random", 
    tol = 1e-8,
    response = 5
  )
```

```{r}
plot(fit_rgcca, type= "sample", comp = 1:2, block = 1, title = "Factorial plan of RGCCA", resp = Y)
plot(fit_rgcca, type= "sample", comp = 1:2, block = 2, title = "Factorial plan of RGCCA", resp = Y)
plot(fit_rgcca, type= "sample", comp = 1:2, block = 3, title = "Factorial plan of RGCCA", resp = Y)
plot(fit_rgcca, type= "sample", comp = 1:2, block = 4, title = "Factorial plan of RGCCA", resp = Y)

```

# Predict on test data
```{r}
L_test = list(TH = team_home_test, PH = player_home_test, TA = team_away_test, PA = player_away_test)
Y_pred = rgcca_predict(fit_rgcca, blocks_test = L_test, prediction_model = "lda")
```

```{r}
plot(fit_rgcca, type= "cor_circle", comp = 1:2)
```

```{r}
plot(fit_rgcca, display_order = TRUE, comp=1, block = 1:4)
```

Optimisation of the sparsity parameters (beware, long computations)
```{r}
fit_rgcca_perm <- rgcca_permutation(
    blocks = L_rgcca, 
    connection = C, 
    method = "sgcca",
    par_type = "sparsity",
    par_length = 10,
    tau = 1,#"optimal",
    sparsity = 0.8,
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 1,
    init = "random", 
    tol = 1e-6,
    response = 5,
    n_cores = 6
  )

```
Best sparsity (approx) : 0.716  0.674  0.716  0.674      0, for a z score of 505 and a p-value of 0

```{r}
summary(fit_rgcca_perm)
```


```{r}
#cv_out = rgcca_cv(L_rgcca,
#                  method = "rgcca",
#                  response = 5,
#                  par_type = "sparsity",
#                  par_length = 10,
#                  ncomp = 1,
#                  prediction_model = "lda",
#                  metric = "Balanced_Accuracy",
#                  k = 3,
#                  n_runs = 2,
#                  n_cores = 8,
#                  NA_method = "na.ignore"
#)
#summary(cv_out)
```



# Attempt with separate blocks for positions, and RGCCA

```{r}
position_filter = c("attacker", "defender", "midfielder", "goalkeeper")

# Create a list with all the blocks, with all different positions (including NA separately), for home and away teams 
player_home_attack <- player_home_raw %>% filter(POSITION == "attacker") %>% select(-c(1))
player_away_attack <- player_away_raw %>% filter(POSITION == "attacker") %>% select(-c(1))
player_home_defense <- player_home_raw %>% filter(POSITION == "defender") %>% select(-c(1))
player_away_defense <- player_away_raw %>% filter(POSITION == "defender") %>% select(-c(1))
player_home_midfield <- player_home_raw %>% filter(POSITION == "midfielder") %>% select(-c(1))
player_away_midfield <- player_away_raw %>% filter(POSITION == "midfielder") %>% select(-c(1))
player_home_goalkeeper <- player_home_raw %>% filter(POSITION == "goalkeeper") %>% select(-c(1))
player_away_goalkeeper <- player_away_raw %>% filter(POSITION == "goalkeeper") %>% select(-c(1))
player_away_na <- player_away_raw %>% filter(is.na(POSITION)) %>% select(-c(1))
player_home_na <- player_home_raw %>% filter(is.na(POSITION)) %>% select(-c(1))

# For all of them, replace NA with 0

# L_rgcca = list(team_home_cut, team_away_cut,
#                 player_home_attack, player_away_attack,
#                 player_home_midfield, player_away_midfield,
#                 player_home_defense, player_away_defense,
#                 player_home_goalkeeper, player_away_goalkeeper,
#                 player_home_na, player_away_na, Y)
L_rgcca = list(team_home_cut, player_home_attack, player_home_midfield, player_home_defense, player_home_goalkeeper, #player_home_na, 
              team_away_cut, player_away_attack, player_away_midfield, player_away_defense, player_away_goalkeeper, #player_away_na, 
              Y)
```



```{r}
C = matrix(c(0,1,1,1,1,1,0,0,0,0,0,0,1,
             1,0,1,0,0,1,0,0,0,0,0,0,1,
             1,1,0,1,0,1,0,0,0,0,0,0,1,
             1,0,1,0,1,1,0,0,0,0,0,0,1,
             1,0,0,1,0,1,0,0,0,0,0,0,1,
             1,1,1,1,1,0,0,0,0,0,0,0,1,
             0,0,0,0,0,0,0,1,1,1,1,1,1,
             0,0,0,0,0,0,1,0,1,0,0,1,1,
             0,0,0,0,0,0,1,1,0,1,0,1,1,
             0,0,0,0,0,0,1,0,1,0,1,1,1,
             0,0,0,0,0,0,1,0,0,1,0,1,1,
             0,0,0,0,0,0,1,1,1,1,1,0,1,
             1,1,1,1,1,1,1,1,1,1,1,1,0), nrow = 13, ncol = 13)

C = matrix(c(0,1,1,1,1,0,0,0,0,0,1,
             1,0,1,0,0,0,0,0,0,0,1,
             1,1,0,1,0,0,0,0,0,0,1,
             1,0,1,0,1,0,0,0,0,0,1,
             1,0,0,1,0,0,0,0,0,0,1,
             0,0,0,0,0,0,1,1,1,1,1,
             0,0,0,0,0,1,0,1,0,0,1,
             0,0,0,0,0,1,1,0,1,0,1,
             0,0,0,0,0,1,0,1,0,1,1,
             0,0,0,0,0,1,0,0,1,0,1,
             1,1,1,1,1,1,1,1,1,1,0), nrow = 11, ncol = 11)
```

```{r}
fit_tgcca <- rgcca(
    blocks = L, 
    connection = C, 
    method = "rgcca", 
    rank = 1,
    tau = "optimal", 
    scale = FALSE, 
    scale_block = TRUE,
    verbose = TRUE, 
    ncomp = 2,
    # init = "random", 
    tol = 1e-8,
    response = 13
  )
```

```{r}
plot(fit_tgcca, type= "sample", comp = 1:2, block = 1, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 2, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 3, title = "Factorial plan of TGCCA", resp = Y)
plot(fit_tgcca, type= "sample", comp = 1:2, block = 4, title = "Factorial plan of TGCCA", resp = Y)
```

```{r}
cv_out = rgcca_cv(L_rgcca,
                 method = "sgcca",
                 response = 11,
                 par_type = "sparsity",
                 par_length = 10,
                 ncomp = 1,
                 prediction_model = "lda",
                 metric = "Balanced_Accuracy",
                 k = 5,
                 n_runs = 2,
                 n_cores = 6,
                #  NA_method = "na.ignore"
)
summary(cv_out)
best_sparsity <- list(cv_out$best_params)
```